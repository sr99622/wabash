#!/bin/bash

deps_list=()   # global list of all unique dependencies found

#
# Return 0 if $1 is already in deps_list, else 1
#
contains() {
    local needle="$1"
    local x
    for x in "${deps_list[@]}"; do
        [[ "$x" == "$needle" ]] && return 0
    done
    return 1
}

#
# Add item to deps_list if not already present
#
add_unique() {
    local item="$1"
    if ! contains "$item"; then
        deps_list+=("$item")
        return 0    # means "was added"
    fi
    return 1        # means "already existed"
}

#
# Recursively walk dependencies of a Mach-O binary
#
find_dependencies() {
    local file="$1"

    #echo "Processing: $file"

    # Find direct dependencies of $file
    local deps
    deps=$(otool -l "$file" | grep -A5 LC_LOAD_DYLIB | grep name | awk '{print $2}')

    local name
    for name in $deps; do
        # Only skip system libs
        local dir_name
        dir_name=$(dirname "$name")

        if [[ "$name" == /usr/lib/* ]] || [[ "$name" == /System/Library/Frameworks/* ]]; then
            continue
        fi

        # Add to global list â€” but only recurse if newly added
        if add_unique "$name"; then
            #echo "Added: $name"

            # Recurse only if the dependency file actually exists
            if [[ -e "$name" ]]; then
                find_dependencies "$name"
            else
                echo "WARNING: Dependency not found on disk: $name"
            fi
        fi

    done
}


echo $VIRTUAL_ENV
#pip install -v .
pyname=$(ls $VIRTUAL_ENV/lib | awk '{print $1}')
pydir="$VIRTUAL_ENV/lib/$pyname/site-packages"
moddir="$pydir/wabash"
/bin/ls "$moddir" | grep "_wabash"
modname="$pydir/wabash/$(/bin/ls -1 "$moddir" | grep "_wabash")"
export executable=$modname
export sourcedir=wabash

echo "executable: ${executable}"
find_dependencies "$executable"

echo
echo "All dependencies found:"
printf '%s\n' "${deps_list[@]}"



#scripts/mac/copy_libs
#scripts/mac/install_name

#rm -rf dist

#pip uninstall -y wabash

#assets/scripts/mac_pkgs
#deactivate
