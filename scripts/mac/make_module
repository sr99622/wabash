#!/bin/bash

deps_list=()   # global list of all unique dependencies found

# Return 0 if $1 is already in deps_list, else 1
contains() {
    local needle="$1"
    local x
    for x in "${deps_list[@]}"; do
        [[ "$x" == "$needle" ]] && return 0
    done
    return 1
}

# Add item to deps_list if not already present
add_unique() {
    local item="$1"
    if ! contains "$item"; then
        deps_list+=("$item")
        return 0    # means "was added"
    fi
    return 1        # means "already existed"
}

# Recursively walk dependencies of a Mach-O binary
find_dependencies() {
    local file="$1"
    local deps
    deps=$(otool -l "$file" | grep -A5 LC_LOAD_DYLIB | grep name | awk '{print $2}')

    local name
    for name in $deps; do
        if [[ "$name" == /usr/lib/* ]] || [[ "$name" == /System/Library/Frameworks/* ]]; then
            continue
        fi
        # Add to global list â€” but only recurse if newly added
        if add_unique "$name"; then
            # Recurse only if the dependency file actually exists
            if [[ -e "$name" ]]; then
                find_dependencies "$name"
            else
                echo "WARNING: Dependency not found on disk: $name"
            fi
        fi
    done
}

if [ -z $VIRTUAL_ENV ]; then
    echo "**"
    echo "** This script is meant to be run inside a virtual environment"
    echo "**"
    exit 1
fi

# compile ffmpeg dependencies
if [ ! -d source ]; then
    mkdir source
fi
if [ ! -d source ]; then
    mkdir build
fi
export SOURCE_DIR=$PWD/source
export BUILD_DIR=$PWD/build
scripts/mac/build_cmake && \
scripts/mac/build_aac && \
scripts/mac/build_x264 && \
scripts/mac/build_x265 && \
scripts/mac/build_sdl2 && \
scripts/mac/build_ffmpeg && \
scripts/mac/build_libxml2

# build first pass module binary
export FFMPEG_INSTALL_DIR=$PWD/build
pip install --upgrade pip
pip install -v .

# find dependencies
pyname=$(/bin/ls $VIRTUAL_ENV/lib | awk '{print $1}')
pydir="$VIRTUAL_ENV/lib/$pyname/site-packages/wabash"
executable="$pydir/$(/bin/ls -1 "$pydir" | grep "_wabash")"
find_dependencies "$executable"

# clear stock folder to hold portable libs and includes
rm -R stock
mkdir -p stock/lib
cp -R build/include stock

# set the rpath
for name in "${deps_list[@]}"; do
    file_name=$(basename "$name")
    install_name_tool -id @loader_path/$file_name $name
    for sub in $(otool -l $name | grep -A5 DYLIB | grep name | awk '{print $2}'); do
        if   [[ "$sub" == /usr/lib/* ]] \
          || [[ "$sub" == /System/Library/Frameworks/* ]] \
          || [[ "$sub" == @loader_path* ]]; then
            continue
        fi
        link_name=$(basename "$sub")
        install_name_tool -change $sub @loader_path/$link_name $name
    done
    # copy dependency to wabash stage and stock folders
    cp "$name" wabash
    cp "$name" stock/lib
done

# add symlinks for libraries in stock folder
cd stock/lib
for name in *.dylib; do
    root="${name%%.[0-9]*}.dylib"
    ln -s "$name" "$root"
done
cd ../..

# build wheel and install
pip install build
python -m build --sdist --wheel
pip uninstall -y wabash
pip install dist/*whl